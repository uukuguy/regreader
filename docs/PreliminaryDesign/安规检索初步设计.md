# **基于 Agentic Workflow（智能体工作流）的电网安规检索系统**

如果你的核心目标是**“让所有规程在指尖秒现”**，我最推荐：

> 正式名称：GridCode项目代号：grid-code中文简称：电网准则 / 规程大脑
> 

**为什么选 GridCode？**

1. **含义双关**：它既指电网的“业务准则”，又契合你追求的“类似 Claude Code”的技术实现。
2. **读音优势**：发音非常干脆，不容易产生吞音。
3. **行业通用**：国际上电力规程常被称为 *Grid Code*，具有天然的权威感。

**GridCode** 不仅仅是一个搜索框，它是电力调度员和安全员随身携带的、精通所有规程的**数字大脑**。

这份方案总结了我们之前的讨论，旨在构建一个**基于 Agentic Workflow（智能体工作流）的电网安规检索系统**。

该系统摒弃了传统 RAG “切片+向量检索”的僵化模式，转而采用类似 **Claude Code** 的架构：**以大模型为核心推理引擎，通过 MCP 协议调用“视觉”与“翻书”工具，动态解析复杂的表格与规则逻辑。**

---

# 电网安规智能体搜索系统设计方案

## 1. 项目概述

目标：构建一个能准确理解电网《安规》复杂逻辑的智能搜索系统。

核心痛点解决：

1. **复杂表格逻辑**：解决多维交叉表格（区域-设备-动作）的语义丢失问题。
2. **跨页与关联**：解决表格跨页截断、规则中包含“见注1”或“参照某条款”的溯源问题。
3. **精准定位**：实现类似 IDE 的代码跳转体验，返回结果包含确切的章节路径和页码。

---

## 2. 总体架构设计

系统采用 **“大脑 (LLM) + 手 (MCP Tools) + 记忆 (Structure Index)”** 的三层架构。

### 2.1 逻辑架构图

代码段

`graph TD
    User[用户输入: "110kV母线失压怎么处理?"] --> Agent[推理引擎 (Claude 3.5 Sonnet)]
    
    subgraph "MCP Server (动作层)"
        Agent -- 1.看目录 --> Tool_TOC[get_toc]
        Agent -- 2.搜关键词 --> Tool_Search[search_index]
        Agent -- 3.读页面 --> Tool_Read[read_pages]
    end
    
    subgraph "数据存储层 (本地轻量化)"
        Tool_TOC --> MetaDB[元数据 (章节树)]
        Tool_Search --> FTS[SQLite FTS5 (全文索引)]
        Tool_Search --> VectorDB[LanceDB (语义索引)]
        Tool_Read --> DocStore[Page-Level Markdown]
    end
    
    Agent -- 4.逻辑缝合 & 溯源 --> User`

---

## 3. 数据层设计 (Data Pipeline)

核心原则：**保留文档物理结构，不进行碎片化切分。**

### 3.1 预处理流程 (Ingestion)

使用 **Docling** 或 **DeepSearch Toolkit** 进行解析：

1. **物理分割**：以“页 (Page)”为最小存储单位，不拆散页内内容。
2. **结构提取**：
    - **TOC 提取**：识别 H1/H2/H3 标题及其对应的页码范围。
    - **表格坐标化**：将 PDF 表格转为带有 metadata 的 Markdown 表格，保留“续表”标记。
3. **索引构建**：
    - **Keyword Index (SQLite FTS5)**：存储 `(content, chapter_path, page_num)`，用于精准定位设备名。
    - **Semantic Index (LanceDB)**：仅针对“故障描述”列建立向量索引，解决“冒烟/着火”等语义模糊匹配。

### 3.2 存储数据模型

每一页的数据结构如下：

JSON

`{
  "page_id": 85,
  "chapter_hierarchy": ["第六章 事故处理", "第三节 母线故障"],
  "content_markdown": "| 故障 | 措施 |\n|---|---|\n| 失压 | 见下页 |...",
  "tables": [
    {"id": "tbl_85_1", "is_truncated": true, "related_notes": ["注1"]}
  ]
}`

---

## 4. MCP Server 接口定义 (工具层)

MCP Server 是连接 LLM 与安规数据的桥梁。

### Tool 1: `get_table_of_contents`

- **功能**：获取全局目录树。
- **用途**：Agent 在搜索前先进行“路由”，决定去哪一章找，避免全书盲搜。

### Tool 2: `search_safety_rules` (Hybrid Search)

- **功能**：混合检索。优先匹配 FTS5 关键词，无结果时回退到 Vector 语义搜索。
- **参数**：
    - `query`: 查询词 (e.g., "母线失压")
    - `scope_chapter`: (可选) 限制在特定章节范围内
- **返回**：
    - `snippet`: 匹配文本片段
    - `location`: `{chapter: "第六章", page: 85}`

### Tool 3: `read_page_content`

- **功能**：读取指定页码的完整 Markdown。
- **特殊逻辑**：
    - 支持 **Window Reading**：允许一次读取 `[page, page+1]`，方便处理跨页表格。
    - 支持 **Annotation Enhancement**：自动将页脚的“注”追加到正文末尾。

---

## 5. 智能体工作流 (Agent Workflow)

这是系统实现“智能化”的核心，通过 System Prompt 驱动。

### 5.1 思考链路 (Chain of Thought)

当用户询问复杂故障时，Agent 执行以下循环：

1. **Phase 1: 范围锁定 (Routing)**
    - *Thought*: "用户问的是变电站故障，我应该先看目录里的'变电站运行'或'事故处理'章节。"
    - *Action*: Call `get_table_of_contents()`.
2. **Phase 2: 精准定位 (Locating)**
    - *Thought*: "目标章节在 P40-P90。通过关键词搜索定位具体表格。"
    - *Action*: Call `search_safety_rules(query="母线失压", scope_chapter="第六章")`.
3. **Phase 3: 深度阅读与缝合 (Deep Reading & Stitching)**
    - *Thought*: "在 P85 发现了表格，但表格在底部截断了，且处置措施写着'见注3'。"
    - *Action*: Call `read_page_content(pages=[85, 86])`.
    - *Logic*: 模型在 Context Window 中将 P85 的表头与 P86 的数据行合并，并找到页脚的“注3”。
4. **Phase 4: 结果生成 (Response)**
    - 输出结构化的 Markdown Snippet。

### 5.2 System Prompt 核心指令

> "你是一个拥有‘动态阅读能力’的安规专家。在回答前，你必须遵循以下协议：
> 
> 1. **目录优先**：先确定章节范围，严禁盲目全书搜索。
> 2. **完整性校验**：遇到跨页表格，必须主动读取下一页。
> 3. **引用追踪**：遇到‘见某条款’或‘注’，必须追踪并展示原文。
> 4. **拒绝对话**：如果是闲聊，直接拒绝；只回答安规相关问题。"

---

## 6. 前端展示设计 (Claude Code Style)

为了模仿 IDE 的极客感和清晰度，前端（CLI 或 Web）应渲染如下格式：

**用户输入**：`110kV母线失压且开关拒动怎么办？`

**系统回复**：

Markdown

`> **定位路径**: 2024安规 / 第六章 事故处理 / 第3节 / 表 6-2 (P85-P86)
> ---------------------------------------------------------

**[故障场景匹配]**
* **区域**: 110kV 母线
* **状态**: 失压 + (关联条件: 开关拒动)

**[标准处置措施]**
1.  **隔离故障**: 拉开拒动断路器两侧隔离开关。
2.  **恢复供电**: 确认母线无故障后，利用旁路或母联恢复送电。
3.  **[关联注释]**: 若伴有SF6气压降低报警，严禁强送（引用自 P86 注2）。

> *[Source]: P85 L12 - P86 L4*`

---

## 7. 技术栈选型推荐

| **组件** | **推荐技术** | **理由** |
| --- | --- | --- |
| **LLM** | **Claude 3.5 Sonnet** (Via API) | 目前对复杂 Instruction Following 和长文本逻辑推理能力最强的模型，适合做 Agent 大脑。 |
| **Agent 框架** | **LangGraph** | 支持循环图结构（Loop），允许 Agent "读一页->不够->再读一页" 的反复操作。 |
| **MCP Server** | **Python (FastMCP)** | 快速构建标准化的工具接口，方便未来对接 Cursor 或 Claude Desktop。 |
| **PDF Parser** | **Docling** | 能够保留表格的层级结构和页码坐标，是本方案的基石。 |
| **Search Engine** | **SQLite FTS5** | 内置于 Python，零部署成本，极其适合本地化的高频关键词匹配。 |

## 8. 实施路线图

1. **Week 1: 数据解析与建库**
    - 编写 Docling 脚本，将 PDF 转为 JSON-L（按页存储）。
    - 建立 SQLite FTS5 索引（Keyword -> Page/Chapter）。
2. **Week 2: MCP Server 开发**
    - 实现 `get_toc`, `search`, `read_page` 三个核心工具。
    - 实现“跨页自动拼接”的预处理逻辑。
3. **Week 3: Agent 编排 (Prompt Engineering)**
    - 使用 LangGraph 定义工作流。
    - 调试 System Prompt，专门测试跨页表格和备注引用的场景。
4. **Week 4: 交互界面与测试**
    - 开发简单的 CLI 或 Streamlit 界面。
    - 邀请安规专工进行“刁钻问题”测试（如多重条件故障）。