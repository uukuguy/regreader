# GridCode：多规程协同智能推理平台设计方案

## 1. 定位与愿景

**GridCode** 旨在打造电力行业的 “Claude Code”。它通过 **MCP (Model Context Protocol)** 协议，使大模型具备在多类规程（安规、稳规、调规）中动态“翻阅、对齐、溯源”的能力。

---

## 2. 核心挑战与应对策略

- **多源异构**：安规重行为规范，稳规重技术限值。
    - *策略*：通过 **Metadata-Tagging** 实现规程分类存储。
- **语义冲突**：不同规程对同一动作描述不一（如“切机”与“跳闸”）。
    - *策略*：利用 **LanceDB 向量检索** 实现业务近义词对齐。
- **逻辑割裂**：规程间存在大量“见《XX导则》”的跨文档引用。
    - *策略*：构建 **Recursive Tools（递归工具）**，让 Agent 能够根据引用自动跳转至另一份规程。

---

## 3. 系统架构设计

### 3.1 逻辑分层

GridCode 采用“分而治之，聚而推理”的架构：

1. **解析层 (Ingestion)**：使用 `Docling` 提取 PDF 物理坐标、表格结构及层级标题，生成带 Metadata 的 Markdown。
2. **存储层 (Multi-Index)**：
    - **SQLite FTS5**：负责精准关键词匹配（设备、专有名词）。
    - **LanceDB**：负责故障现象与处置动作的语义关联。
3. **动作层 (MCP Server)**：提供具备空间感知能力的 API 接口（如按页读取、按章搜索）。
4. **推理层 (Agentic Brain)**：基于 Claude 3.5 的决策大脑，负责多步搜索与跨文档逻辑拼凑。

---

## 4. MCP Server 工具定义 (多规程版)

为了支持多规程，接口引入了 `reg_type` 路由参数：

| **工具名称** | **输入参数** | **核心功能** |
| --- | --- | --- |
| `get_reg_catalog` | `None` | 返回系统中所有已加载的规程列表（安规2024、稳规2022等）。 |
| `list_toc` | `reg_type` | 获取特定规程的章节目录树。 |
| `smart_search` | `query`, `reg_type[]` | 在选定规程中执行混合搜索，返回带 Page/Chapter 的 Snippets。 |
| `read_segment` | `reg_type`, `page_range` | 读取特定页面的 Markdown，自动执行跨页表格合并。 |

---

## 5. 推理逻辑：跨规程协同 (Chain-of-Reference)

当用户输入一个涉及多标准的复杂问题时，Agent 的执行链路如下：

1. **意图拆解**：模型识别出问题涉及“稳规的系统稳定性”和“安规的操作安全”。
2. **并行探测**：
    - 调用 `smart_search` 在**稳规**中查找特定故障下的稳定性判定准则。
    - 调用 `smart_search` 在**安规**中查找相关设备的隔离与带电作业要求。
3. **冲突检查与对齐**：
    - 模型分析发现稳规要求“立即切除”，安规要求“切除前需核实汇报”。
    - 模型在回答中会明确标注：**“依据稳规，需执行XXX；但依据安规，执行前须满足XXX条件。”**
4. **引用闭环**：如果文中提到“参考调规第5条”，Agent 会自动发起第三次搜索，补全缺失信息。

---

## 6. 数据解析与存储细节

### 6.1 增强型 Markdown 转换

在解析安规和稳规表格时，GridCode 会在 Markdown 层面进行“语义注入”：

Markdown

`## [Chapter: 事故处理 | Page: 45]
| 故障情况 (Condition) | 处置步骤 (Action) | 备注 (Notes) |
| :--- | :--- | :--- |
| 110kV母线失压 | 1. 汇报调度... | 见注1 |

[Annotation: 注1] 若开关拒动，执行分段隔离方案。`

### 6.2 本地索引实现 (Python 伪代码)

Python

`# 使用 SQLite FTS5 建立多规程索引
def index_page(reg_type, page_num, content, chapters):
    # 将章节路径拼接为字符串以便搜索
    path = " > ".join(chapters)
    cursor.execute(
        "INSERT INTO grid_code_idx (reg_type, page_num, path, content) VALUES (?, ?, ?, ?)",
        (reg_type, page_num, path, content)
    )`

---

## 7. 交互界面设计 (The GridCode CLI)

仿照 Claude Code 的交互感，强调**来源透明性**：

Bash

`>>> @GridCode 110kV开关柜着火怎么处理？

[Thought]: 
1. 正在检索《安规》防火章节... 
2. 发现表 8-4 (措施代码 FIRE-03)。
3. FIRE-03 对应具体步骤位于 P86 备注。
4. 正在核对《调规》中关于开关柜事故的汇报流程...

[GridCode 处置建议]:
------------------------------------------------------------
1. [应急] 立即拉开火灾柜及相邻柜断路器 (来源: 安规 P85 表8-4)
2. [灭火] 使用干粉灭火器，保持安全距离 (来源: 安规 P86 注2)
3. [汇报] 3分钟内向地调值班员报告事故简要经过 (来源: 调规 P12)
------------------------------------------------------------
> 输入 'o' 在浏览器中打开原始 PDF 页
> 输入 'v' 查看规程间的逻辑关联图`

---

## 8. 实施路径 (Implementation Roadmap)

1. **Phase 1 (基础)**：使用 `Docling` 完成安规、稳规的结构化解析，建立基于 SQLite 的页面级索引。
2. **Phase 2 (工具)**：开发基于 FastMCP 的服务端，实现目录浏览、关键词定位、跨页读取。
3. **Phase 3 (大脑)**：配置 LangGraph 循环推理逻辑，专门调优“跨文档引用”和“复杂表格解析”的 Prompt。
4. **Phase 4 (部署)**：封装为 CLI 工具或集成至企业内部通讯软件（如钉钉/飞书）。

**GridCode** 不仅仅是一个搜索框，它是电力调度员和安全员随身携带的、精通所有规程的**数字大脑**。